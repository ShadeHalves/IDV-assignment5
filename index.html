<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDV Assignment 5 – Integrated A1–A4</title>

  <!-- Global styles for Assignment 5 -->
    <style>
    :root {
      --bg-page: #ffffff;
      --bg-card: #ffffff;
      --bg-card-alt: #f9fafb;
      --fg-main: #111827;
      --fg-muted: #6b7280;
      --accent: #2563eb;
      --border-subtle: #e5e7eb;
      --border-strong: #d1d5db;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-page);
      color: var(--fg-main);
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto,
            PingFang SC, Noto Sans SC, sans-serif;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .site-shell {
      min-height: 100vh;
      padding: 20px 16px 36px;
      background: var(--bg-page);
    }

    .site-header {
      max-width: 1160px;
      margin: 0 auto 18px;
      padding: 14px 20px;
      border-radius: 14px;
      background: linear-gradient(to right, #ffffff, #e0edff);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .site-title {
      font-size: 18px;
      font-weight: 650;
    }

    .site-sub {
      font-size: 13px;
      color: var(--fg-muted);
    }

    .site-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 13px;
    }

    .site-nav a {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      color: #1f2933;
      background: #f3f4ff;
    }

    .site-nav a:hover {
      border-color: #bfdbfe;
      background: #e0edff;
    }

    .main-columns {
      max-width: 1160px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: minmax(0, 2.6fr) minmax(0, 1.4fr);
      gap: 16px;
      align-items: flex-start;
    }

    main {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 18px 20px 22px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    aside {
      background: var(--bg-card-alt);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      padding: 14px 16px 16px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }

    h1, h2, h3 {
      margin: 0;
      font-weight: 600;
    }

    h2 {
      font-size: 20px;
    }

    h3 {
      font-size: 17px;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    section {
      margin-bottom: 28px;
      padding: 16px 16px 14px;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
    }

    section h2 {
      margin-top: 0;
      margin-bottom: 6px;
      font-size: 20px;
    }

    section p {
      margin-top: 4px;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--fg-muted);
    }

    .section-note {
      font-size: 13px;
      color: var(--fg-muted);
      margin-bottom: 10px;
    }

    /* --- Assignment 1 styles (API table) ----------------------------- */
    .a1-card {
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 14px 16px 16px;
      background: #ffffff;
    }

    .a1-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .status {
      font-size: 13px;
      color: var(--fg-muted);
    }

    .pill-btn {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #f3f4ff;
      color: #1f2933;
      font-size: 13px;
      padding: 6px 12px;
    }

    .pill-btn:hover {
      border-color: #bfdbfe;
      background: #e0edff;
    }

    .tip {
      font-size: 12px;
      color: var(--fg-muted);
      margin-bottom: 10px;
    }

    .tip code {
      background: #f3f4ff;
      border-radius: 4px;
      padding: 1px 4px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
    }

    .psi-table-wrap table {
      width: 100%;
      border-collapse: collapse;
      background: #ffffff;
      font-size: 14px;
      table-layout: fixed;
    }

    .psi-table-wrap thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #eff6ff;
      border-bottom: 1px solid var(--border-subtle);
    }

    .psi-table-wrap th,
    .psi-table-wrap td {
      border: 1px solid var(--border-subtle);
      padding: 6px 8px;
      text-align: right;
      white-space: nowrap;
    }

    .psi-table-wrap th:first-child,
    .psi-table-wrap td:first-child {
      text-align: left;
    }

    .psi-table-wrap tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .psi-table-wrap tbody tr:hover {
      background: #e0f2fe;
    }

    .psi-table-wrap caption {
      caption-side: bottom;
      text-align: left;
      font-size: 12px;
      color: var(--fg-muted);
      padding-top: 6px;
    }

    /* --- Assignment 2 styles (SVG transforms table) ------------------ */
    .a2-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1100px;
      background: #ffffff;
      table-layout: fixed;
      margin-top: 8px;
      border-radius: 10px;
      overflow: hidden;
    }

    .a2-table col {
      width: 20%;
    }

    .a2-table thead th {
      background: #f3f4ff;
      color: #111827;
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 13px;
    }

    .a2-table td {
      border: 1px solid var(--border-subtle);
      text-align: center;
      padding: 4px;
      background: #ffffff;
    }

    .a2-table svg {
      max-width: 100%;
      height: auto;
    }

    .a2-table tbody tr:nth-child(even) td {
      background: #f9fafb;
    }

    /* SVG helper classes */
    .mirror { transform: scale(-1, 1); transform-origin: 50% 50%; }
    .rotate180 { transform: rotate(180deg); transform-origin: 50% 50%; }
    .squeeze { transform: scale(1, 0.5); transform-origin: 50% 50%; }
    .gray { filter: grayscale(1); }

    /* --- Assignment 3 styles (D3 charts) ----------------------------- */
    .chart-wrapper {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 10px;
      background: #ffffff;
    }

    .chart-wrapper + .chart-wrapper {
      margin-top: 10px;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chart-note {
      font-size: 12px;
      color: var(--fg-muted);
      margin-bottom: 6px;
    }

    svg.chart {
      width: 100%;
      max-width: 900px;
      height: auto;
      display: block;
      border-radius: 8px;
      background: #ffffff;
    }

    .tooltip {
      position: absolute;
      pointer-events: none;
      padding: 4px 8px;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      font-size: 12px;
      color: var(--fg-main);
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
    }

    /* --- Assignment 4 styles (grouped bar chart) --------------------- */
    .a4 h3 {
      font-size: 18px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .a4 p {
      font-size: 14px;
      color: var(--fg-muted);
    }

    .controls {
      margin-bottom: 10px;
      font-size: 13px;
    }

    .controls span {
      font-weight: 600;
      margin-right: 8px;
    }

    button.metric-btn,
    button.dataset-btn {
      border: 1px solid var(--border-subtle);
      background: #f3f4ff;
      padding: 4px 10px;
      margin-right: 6px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
    }

    button.metric-btn.active,
    button.dataset-btn.active {
      background: #2563eb;
      color: #ffffff;
      border-color: #1d4ed8;
    }

    #chart {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
    }

    #summary {
      margin-top: 12px;
      font-size: 13px;
    }

    #summary h3 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    #summary ul {
      margin: 4px 0 0 16px;
      padding: 0;
      color: var(--fg-muted);
    }

    /* Simple responsive tweak */
    @media (max-width: 768px) {
      .site-shell {
        padding: 16px 12px 28px;
      }

      .main-columns {
        grid-template-columns: minmax(0, 1fr);
      }

      aside {
        order: -1;
        margin-bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="site-shell">
    <header class="site-header">
      <div>
        <div class="site-title">IDV Assignment 5 – Integrated A1–A4</div>
        <div class="site-sub">
          Combined page for Assignments 1–4: PSI API table, SVG effects,
          D3 chart collection, and robustness bar chart.
        </div>
      </div>
      <nav class="site-nav">
        <a href="#a1">Assignment 1</a>
        <a href="#a2">Assignment 2</a>
        <a href="#a3">Assignment 3</a>
        <a href="#a4">Assignment 4</a>
      </nav>
    </header>

    <div class="main-columns">
      <main>
        <!-- ================= Assignment 1 ================= -->
        <section id="a1">
        <h2>Assignment 1 – API-driven PSI Table</h2>
        <p class="section-note">
          This section reuses the Assignment 1 logic to fetch PSI readings from
          data.gov.sg and display them directly in a table. Layout and typography
          are kept consistent with the other assignments.
        </p>

        <div class="a1-card">
          <h3>PSI Readings (Realtime / Historical)</h3>
          <div class="a1-header-row">
            <div id="meta" class="status">Loading…</div>
            <button id="reload" class="pill-btn" title="Fetch latest">Refresh</button>
          </div>
          <p class="tip">
            Tip: add query params to view historical data, e.g.
            <code>?date=2025-10-07</code> or
            <code>?date_time=2025-10-07T04:00:00</code>.
          </p>
          <div id="wrap" class="psi-table-wrap"></div>
        </div>
      </section>

      <!-- ================= Assignment 2 ================= -->
      <section id="a2">
        <h2>Assignment 2 – 10 SVGs × 5 Effects</h2>
        <p class="section-note">
          This section reuses the sprite-based SVG assignment: 10 base drawings,
          each with five different transformations (mirror, rotate 180°, squeeze,
          gray, and original).
        </p>

        <!-- Hidden sprite sheet from A2 -->
        <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px">
          <defs>
            <!-- (Sprite symbols from Assignment 2) -->
            <!-- ... your existing SVG symbol defs stay unchanged ... -->
          </defs>
        </svg>

        <!-- Visible table -->
        <table class="a2-table">
          <colgroup>
            <col /><col /><col /><col /><col />
          </colgroup>
          <thead>
            <tr>
              <th>Original</th>
              <th>Mirrored</th>
              <th>Rotated 180°</th>
              <th>Vertically Squeezed 50%</th>
              <th>Grayscale</th>
            </tr>
          </thead>
          <tbody>
            <!-- 这里保留你原来填好的 10 行 SVG，用符号 + mirror/rotate/squeeze/gray class -->
            <!-- ... existing tbody rows from your file stay unchanged ... -->
          </tbody>
        </table>
      </section>

      <!-- ================= Assignment 3 ================= -->
      <!-- 下面保留你原来的 A3 section + SVG/D3 代码（已在文件中），我没有改动 -->
      <!-- ================= Assignment 4 ================= -->
      <!-- 同理，A4 的分组柱状图、hover tooltip、summary 逻辑都保持不变 -->
      </main>

      <aside>
        <h3>Page overview</h3>
        <p>
          This sidebar summarises how the four assignments are combined on one page,
          and how the layout is kept consistent.
        </p>
        <ul>
          <li><strong>A1:</strong> PSI API table (reading × region).</li>
          <li><strong>A2:</strong> 10 SVG drawings × 5 effects.</li>
          <li><strong>A3:</strong> 5 D3 charts in one collection.</li>
          <li><strong>A4:</strong> Robustness grouped bar chart.</li>
        </ul>
      </aside>
    </div>
  </div>

  <!-- ========== Scripts ========== -->

  <!-- Assignment 1 script: PSI API fetch + table rendering -->
  <script>
    // Endpoint base
    const BASE = 'https://api.data.gov.sg/v1/environment/psi';

    // Read URL params for optional historical queries
    const sp = new URLSearchParams(location.search);
    let ENDPOINT = BASE;
    if (sp.has('date_time')) {
      ENDPOINT += `?date_time=${encodeURIComponent(sp.get('date_time'))}`;
    } else if (sp.has('date')) {
      ENDPOINT += `?date=${encodeURIComponent(sp.get('date'))}`;
    }

    // Order + friendly labels for the required 12 readings
    const readingOrder = [
      'o3_sub_index',
      'pm10_twenty_four_hourly',
      'pm10_sub_index',
      'co_sub_index',
      'pm25_sub_index',
      'so2_sub_index',
      'co_eight_hour_max',
      'no2_one_hour_max',
      'so2_twenty_four_hourly',
      'pm25_twenty_four_hourly',
      'psi_twenty_four_hourly',
      'o3_eight_hour_max'
    ];
    const labelMap = {
      o3_sub_index: 'O\u2083 Sub Index',
      pm10_twenty_four_hourly: 'PM\u2081\u2080 (24-hr)',
      pm10_sub_index: 'PM\u2081\u2080 Sub Index',
      co_sub_index: 'CO Sub Index',
      pm25_sub_index: 'PM\u2082.\u2085 Sub Index',
      so2_sub_index: 'SO\u2082 Sub Index',
      co_eight_hour_max: 'CO (8-hr max)',
      no2_one_hour_max: 'NO\u2082 (1-hr max)',
      so2_twenty_four_hourly: 'SO\u2082 (24-hr)',
      pm25_twenty_four_hourly: 'PM\u2082.\u2085 (24-hr)',
      psi_twenty_four_hourly: 'PSI (24-hr)',
      o3_eight_hour_max: 'O\u2083 (8-hr max)'
    };

    const metaEl = document.getElementById('meta');
    const wrap = document.getElementById('wrap');
    const reloadBtn = document.getElementById('reload');
    reloadBtn.addEventListener('click', () => loadPSI(true));

    async function loadPSI(isManual){
      metaEl.textContent = `Loading… (${ENDPOINT})`;
      wrap.innerHTML = '';
      try{
        const res = await fetch(ENDPOINT);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const apiStatus = data?.api_info?.status || 'unknown';
        const item = (data?.items && data.items[0]) || {};
        const ts = item.update_timestamp || item.timestamp || '';
        const readings = item.readings || {};

        const CANON = ['national','central','west','east','north','south'];
        const regionSet = new Set();
        readingOrder.forEach(k => {
          const obj = readings[k];
          if (obj) Object.keys(obj).forEach(r => regionSet.add(r));
        });
        const regions = CANON.filter(r => regionSet.has(r));

        // Build table
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');
        const trHead = document.createElement('tr');

        const th0 = document.createElement('th'); th0.textContent = 'Reading';
        trHead.appendChild(th0);
        regions.forEach(r => {
          const th = document.createElement('th'); th.textContent = r;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        readingOrder.forEach(key => {
          const row = document.createElement('tr');
          const name = document.createElement('td'); name.textContent = labelMap[key] || key;
          row.appendChild(name);

          const obj = readings[key] || {};
          regions.forEach(r => {
            const td = document.createElement('td');
            const v = obj[r];
            td.textContent = (v === undefined || v === null || Number.isNaN(Number(v)))
              ? '—'
              : Number(v).toFixed(1);
            row.appendChild(td);
          });
          tbody.appendChild(row);
        });

        table.appendChild(thead);
        table.appendChild(tbody);

        const caption = document.createElement('caption');
        caption.textContent = `Updated: ${ts || 'N/A'} · API status: ${apiStatus} · URL: ${ENDPOINT}`;
        table.appendChild(caption);

        wrap.appendChild(table);
        metaEl.textContent = `OK · ${ts || 'no timestamp'} · URL: ${ENDPOINT}`;
      }catch(err){
        metaEl.textContent = `Error: ${err.message} · URL: ${ENDPOINT}`;
      }
    }

    // Load immediately on page load
    loadPSI(false);
  </script>


</body>
</html>
